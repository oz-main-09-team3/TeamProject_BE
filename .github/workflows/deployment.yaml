name: Django EC2 Deployment

on:
  workflow_run:
    workflows: [ "Django Project CI" ]   # CI 워크플로우 이름과 일치시켜 주세요
    types: [ completed ]

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: ubuntu-latest

    steps:
      - name: EC2 ssh connection and deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ~/TeamProject_BE
            git pull origin main
            
            mkdir -p envs
            echo "DJANGO_SETTINGS_MODULE=config.settings.prod" > envs/prod.env
            echo "ENV_MODE=prod" >> envs/prod.env
            echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> envs/prod.env
            echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> envs/prod.env
            echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> envs/prod.env
            echo "POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}" >> envs/prod.env
            echo "POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}" >> envs/prod.env
            echo "DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" >> envs/prod.env
            echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> envs/prod.env
            echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}" >> envs/prod.env
            echo "AWS_STORAGE_BUCKET_NAME=${{ secrets.AWS_STORAGE_BUCKET_NAME }}" >> envs/prod.env
            echo "AWS_S3_REGION_NAME=${{ secrets.AWS_S3_REGION_NAME }}" >> envs/prod.env # 사용하는 리전
            echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> envs/prod.env
            echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_CLOUDFRONT_DOMAIN }}" >> envs/prod.env
            echo "AWS_CLOUDFRONT_DOMAIN=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> envs/prod.env
            echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" >> envs/prod.env
            

            source ~/.zshrc
            poetry install --no-interaction --no-ansi
            python manage.py migrate --noinput
            python manage.py collectstatic --noinput

            sudo systemctl restart gunicorn
